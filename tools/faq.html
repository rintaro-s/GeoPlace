<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GeoPlace - Offline FAQ</title>
    <style>
    :root{--accent:#0b5;--muted:#666;--bg:#fafbfd;--panel:#fff;--code-bg:#0f1720;--code-fg:#e6eef6}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;background:var(--bg);color:#0b1220}
    header{padding:14px 18px;background:linear-gradient(90deg,var(--accent),#07a);color:white;font-weight:700;font-size:16px}
    #container{display:grid;grid-template-columns:260px 420px 1fr;gap:12px;padding:12px;height:calc(100vh - 56px);box-sizing:border-box}
    #left,#center,#right{background:var(--panel);border-radius:10px;box-shadow:0 6px 18px rgba(16,24,40,0.06);padding:12px;overflow:auto}
    .panel-title{font-size:13px;margin-bottom:8px;font-weight:700;color:#062}
    select,input[type=text]{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #e6eef6;background:#fbfeff}
    ul{list-style:none;padding:0;margin:0}
    li.item{padding:10px;border-radius:8px;margin-bottom:8px;cursor:pointer;border:1px solid #f1f5f9}
    li.item:hover{background:#f5fbff;border-color:#e6f5ff}
    li.item.selected{background:linear-gradient(90deg,#f0fbff,#eef9ff);border-left:4px solid var(--accent);padding-left:12px}
    .meta{font-size:12px;color:var(--muted);margin-top:8px}
    .answer{white-space:pre-wrap;font-size:14px;line-height:1.5;color:#072}
    .small{font-size:12px;color:#5b6b73}
    .search-hint{font-size:12px;color:var(--muted);margin-top:6px}
    .pill{display:inline-block;padding:4px 8px;background:#f3f7f9;border-radius:999px;margin-right:6px;font-size:12px;color:#294}
    .btn{display:inline-block;padding:8px 12px;background:var(--accent);color:white;border-radius:8px;text-decoration:none;border:none;cursor:pointer}
    pre.code{background:var(--code-bg);color:var(--code-fg);padding:10px;border-radius:8px;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Noto Sans Mono', monospace;font-size:13px}
    .file-actions{margin-top:8px;display:flex;gap:8px;align-items:center}
    .file-actions .btn.secondary{background:#6b7280}
    footer{padding:10px 14px;font-size:12px;color:var(--muted);border-top:1px solid #eef2f7}
    @media(max-width:1000px){#container{grid-template-columns:1fr}} 
    </style>
  <style>
  /* QA card styles */
  .qa-card{border-radius:8px;background:#fff;border:1px solid #e6eef6;padding:8px;margin-bottom:10px}
  .qa-header{font-weight:700;color:#083;padding:8px 4px;border-bottom:1px dashed #eef3f7}
  .qa-body{padding:8px 4px;display:flex;flex-wrap:wrap}
  .qa-row{margin-bottom:6px}
  .qa-expanded{margin-top:12px;background:#fbfffc;padding:10px;border-radius:8px;border:1px solid #e8f7ed}
  </style>
</head>
<body>
  <header>GeoPlace — オフライン FAQ（静的）</header>
  <div id="container">
    <div id="left">
  <div class="panel-title">カテゴリ</div>
  <select id="genreSelect" size="8"></select>
  <div class="panel-title">サブカテゴリ</div>
  <select id="subgenreSelect" size="6"></select>
  <div id="subgenreLabel" class="small meta" style="margin-top:6px">選択されたサブカテゴリ: <span id="subgenreName">-</span></div>
  <div class="panel-title">検索（全文）</div>
  <input type="text" id="searchBox" placeholder="キーワードで検索（例: world_new、VLM、TripoSR）">
      <div class="search-hint">検索はジャンル/サブジャンルをまたいで実行されます。キーボードで選択を切り替えられます。</div>
    </div>
    <div id="center">
      <div class="panel-title">質問一覧 <span id="count" class="small"></span></div>
      <div id="questionList"></div>
    </div>
    <div id="right">
      <div class="panel-title">回答</div>
  <div id="answerArea" class="answer">質問を選択してください。</div>
      <div style="margin-top:12px">
        <button id="copyBtn" class="btn">回答をコピー</button>
        <a id="openRepo" class="btn" style="background:#337ab7;margin-left:8px" href="#" target="_blank">リポジトリを開く（既定のブラウザ）</a>
      </div>
    <div style="margin-top:12px" class="meta" id="rightMeta" hidden>ファイルはローカルに保存されています: <span class="pill">tools/faq.html</span></div>
    </div>
  </div>
  <footer style="font-size:12px;color:#666;padding:6px 12px">静的 FAQ（自動生成テンプレート含む）</footer>

  <script>
    // FAQ データは外部 JSON (faq_data.json) から読み込みます。
    // ブラウザで動作させる場合は、faq.html と同じディレクトリに faq_data.json を配置し、HTTP 経由で配信してください。
    let genres = [];
    const repoRoot = 'C:/Users/s-rin/Documents/GitHub/GeoPlace';

    // JSON を読み込み、UI を初期化する関数。フェールオーバーはエラーメッセージを表示します。
    async function loadFAQFromJSON(){
      try{
        const resp = await fetch('./faq_data.json');
        if(!resp.ok) throw new Error('HTTP ' + resp.status + ' ' + resp.statusText);
        const data = await resp.json();
        genres = data.genres || [];
        // if UI elements already exist, populate selects and render
        if(typeof genreSelect !== 'undefined' && genreSelect){
          genreSelect.innerHTML = '';
          genres.forEach((g,idx)=>{ const o = document.createElement('option'); o.value = idx; o.textContent = `${g.name} (${g.subs?g.subs.length:0})`; genreSelect.appendChild(o); });
          genreSelect.selectedIndex = 0;
          populateSubgenres(0);
          renderQuestions();
          // apply deep links after data loaded
          try{ applyDeepLink(); }catch(e){}
        }
      }catch(err){
        console.error('faq_data.json load failed', err);
        questionList.innerHTML = `<div class="small meta">FAQ データの読み込みに失敗しました。tools/faq_data.json が存在し、サーバ経由でアクセス可能か確認してください。</div>`;
        answerArea.textContent = 'FAQ データが読み込めません。ローカルファイルから直接開いている場合、ブラウザの制限で fetch が失敗することがあります。';
      }
    }

    // UI state
    const genreSelect = document.getElementById('genreSelect');
    const subgenreSelect = document.getElementById('subgenreSelect');
    const searchBox = document.getElementById('searchBox');
    const questionList = document.getElementById('questionList');
    const answerArea = document.getElementById('answerArea');
    const countSpan = document.getElementById('count');
    const copyBtn = document.getElementById('copyBtn');
    const openRepo = document.getElementById('openRepo');

    openRepo.addEventListener('click', (e)=>{
      // Prefer PUBLIC_URL if backend exposes one via /api/public_info
      e.preventDefault();
      fetch('/api/public_info').then(r=>r.json()).then(info=>{
        if(info && info.public_url){
          // open the repo root on the public host
          window.open(info.public_url, '_blank');
        } else {
          // try local file:// fallback
          const fileUrl = 'file:///' + encodeURI(repoRoot.replace(/\\/g, '/'));
          window.open(fileUrl, '_blank');
        }
      }).catch(()=>{
        const fileUrl = 'file:///' + encodeURI(repoRoot.replace(/\\/g, '/'));
        window.open(fileUrl, '_blank');
      });
    });

    // populate genres
    genres.forEach((g,idx)=>{
      const o = document.createElement('option'); o.value = idx; o.textContent = `${g.name} (${g.subs.length})`; genreSelect.appendChild(o);
    });
    genreSelect.selectedIndex = 0;
    populateSubgenres(0);

    genreSelect.addEventListener('change', ()=>{
      populateSubgenres(genreSelect.selectedIndex);
      renderQuestions();
    });
    subgenreSelect.addEventListener('change', ()=>{ renderQuestions(); });
    searchBox.addEventListener('input', ()=>{ renderQuestions(); });
    copyBtn.addEventListener('click', ()=>{
      // copy rendered answer as plain text
      const tmp = document.createElement('div'); tmp.innerHTML = answerArea.innerHTML || '';
      const text = tmp.textContent || '';
      navigator.clipboard.writeText(text).then(()=>{ copyBtn.textContent='コピーしました'; setTimeout(()=>copyBtn.textContent='回答をコピー',1200); });
    });

    function populateSubgenres(genreIdx){
      subgenreSelect.innerHTML = '';
      const subs = (genres[genreIdx] && genres[genreIdx].subs) ? genres[genreIdx].subs : [];
      if(subs.length === 0){
        const o = document.createElement('option'); o.value = 0; o.textContent = '（サブカテゴリなし）'; o.disabled = true; subgenreSelect.appendChild(o);
        subgenreSelect.selectedIndex = 0;
        document.getElementById('subgenreName').textContent = '（なし）';
        return;
      }
      subs.forEach((s,si)=>{ const o = document.createElement('option'); o.value = si; o.textContent = s.name + ' ('+ s.qas.length +')'; o.dataset.name = s.name; subgenreSelect.appendChild(o); });
      // ensure selectedIndex valid
      subgenreSelect.selectedIndex = Math.min(Math.max(0, subgenreSelect.selectedIndex), subs.length-1);
      document.getElementById('subgenreName').textContent = subs[subgenreSelect.selectedIndex].name || '-';
    }

    function renderQuestions(){
      let gIdx = genreSelect.selectedIndex; let sIdx = subgenreSelect.selectedIndex;
      if(typeof gIdx !== 'number' || gIdx < 0 || gIdx >= genres.length) gIdx = 0;
      const subs = (genres[gIdx] && genres[gIdx].subs) ? genres[gIdx].subs : [];
      if(typeof sIdx !== 'number' || sIdx < 0 || sIdx >= subs.length) sIdx = 0;
      // update visible subgenre label
      document.getElementById('subgenreName').textContent = (subs[sIdx] && subs[sIdx].name) ? subs[sIdx].name : '（なし）';
      let qList = [];
      let groupBySub = false;
      if(searchBox.value.trim().length>0){
        // full-text search across all questions
        const q = searchBox.value.trim().toLowerCase();
        genres.forEach((g,gi)=> g.subs.forEach((s,si)=> s.qas.forEach((qa,qi)=>{
          if((qa.question+qa.answer).toLowerCase().includes(q)) qList.push({g:gi,s:si,qa:qa, subName:s.name});
        }))); 
      } else {
        // group by subcategory for current genre
        groupBySub = true;
        qList = subs.map((sub,si)=>({sub, si, qas: sub.qas}));
      }
      // render as accordion cards grouped by subcategory
        questionList.innerHTML='';
        let total = 0;
        if(groupBySub){
          qList.forEach((group, gi)=>{
            const card = document.createElement('div'); card.className = 'qa-card';
            const header = document.createElement('div'); header.className='qa-header'; header.textContent = group.sub.name + ` (${group.qas.length})`;
            const body = document.createElement('div'); body.className='qa-body';
            group.qas.forEach((qa,qi)=>{
              const qRow = document.createElement('div'); qRow.className='qa-row';
              const qbtn = document.createElement('button'); qbtn.className='btn'; qbtn.style.margin='6px 6px 6px 0'; qbtn.textContent = qa.question;
              qbtn.addEventListener('click', ()=>{ renderExpandedAnswer({g:gIdx,s:group.si,qa:qa}); });
              qRow.appendChild(qbtn);
              body.appendChild(qRow);
              total++;
            });
            card.appendChild(header); card.appendChild(body); questionList.appendChild(card);
          });
        } else {
          // search results: group by subName header
          let currentSub = null; let subBody = null;
          qList.forEach((entry,i)=>{
            if(i===0 || entry.subName !== currentSub){
              currentSub = entry.subName || '(サブカテゴリ)';
              const card = document.createElement('div'); card.className = 'qa-card';
              const header = document.createElement('div'); header.className='qa-header'; header.textContent = currentSub;
              subBody = document.createElement('div'); subBody.className='qa-body';
              card.appendChild(header); card.appendChild(subBody);
              questionList.appendChild(card);
            }
            const qbtn = document.createElement('button'); qbtn.className='btn'; qbtn.style.margin='6px 6px 6px 0'; qbtn.textContent = entry.qa.question;
            qbtn.addEventListener('click', ()=>{ renderExpandedAnswer(entry); });
            subBody.appendChild(qbtn);
            total++;
          });
        }
        countSpan.textContent = `(${total})`;
        if(total===0) answerArea.textContent = '該当する質問がありません。キーワードを変えて検索してください。';
    }

    window.openFileLocal = function(encodedPath){
      try{
        const p = decodeURIComponent(encodedPath).replace(/\\/g, '/');
        // attempt file:// link (may be blocked by browser from http pages)
        const fileUrl = 'file:///' + p.replace(/^\/+/, '');
        window.open(fileUrl, '_blank');
      }catch(e){
        console.warn('openFileLocal failed', e);
        alert('ローカル表示に失敗しました。ブラウザ権限を確認してください。');
      }
    };

    // keyboard shortcuts
    document.addEventListener('keydown', (e)=>{
      if(e.key==='/' && document.activeElement!==searchBox){ e.preventDefault(); searchBox.focus(); }
    });

    // render expanded detailed answer
    function renderExpandedAnswer(entry){
      try{
        const qa = entry.qa || entry;
        // build a rich answer with multiple sections
        const container = document.createElement('div'); container.className='qa-expanded';
        const title = document.createElement('h3'); title.textContent = qa.question; container.appendChild(title);
        // raw answer may already contain HTML sections from generator
        const ansHtml = document.createElement('div'); ansHtml.innerHTML = qa.answer || ''; container.appendChild(ansHtml);
        // add file action buttons if generator supplied a path anchor
        const meta = document.createElement('div'); meta.className='meta'; meta.style.marginTop='8px';
        const copyLocal = document.createElement('button'); copyLocal.className='btn'; copyLocal.textContent='回答をコピー';
        copyLocal.addEventListener('click', ()=>{ navigator.clipboard.writeText(ansHtml.textContent || qa.answer || ''); copyLocal.textContent='コピーしました'; setTimeout(()=>copyLocal.textContent='回答をコピー',1200); });
        meta.appendChild(copyLocal);
        container.appendChild(meta);
        // display in right panel
        answerArea.innerHTML = '';
        answerArea.appendChild(container);
        // scroll into view
        answerArea.scrollIntoView({behavior:'smooth'});
      }catch(e){ console.error('renderExpandedAnswer error', e); answerArea.textContent = '回答の表示でエラーが発生しました。開発者に報告してください。'; }
    }

    // legacy selectQuestion for compatibility
    function selectQuestion(entry){ renderExpandedAnswer(entry); }

    // deep link support: ?q=... or ?genre=Backend&sub=...
    (function applyDeepLink(){
      try{
        const params = new URLSearchParams(location.search);
        const q = params.get('q');
        const genre = params.get('genre');
        const sub = params.get('sub');
        if(q){ searchBox.value = q; renderQuestions(); }
        else if(genre){ const gi = genres.findIndex(g=>g.name.toLowerCase()===genre.toLowerCase()); if(gi>=0){ genreSelect.selectedIndex=gi; populateSubgenres(gi); if(sub){ const si = genres[gi].subs.findIndex(s=>s.name.toLowerCase()===sub.toLowerCase()); if(si>=0) subgenreSelect.selectedIndex = si; } renderQuestions(); } }
      }catch(e){/* no-op */}
    })();

    // helper: open a file via an HTTP preview (this expects a running simple HTTP server)
    function viewFileHTTP(encodedPath){
      try{
        const p = decodeURIComponent(encodedPath);
        // Ask backend if it knows a public URL to prefer
        fetch('/api/public_info').then(r=>r.json()).then(info=>{
          if(info && info.public_url){
            // build absolute URL relative to public host
            const base = info.public_url.replace(/\/$/, '');
            const rel = p.replace(/^\/+/, '');
            window.open(base + '/' + rel, '_blank');
          } else {
            const url = './' + p.replace(/^\/+/, '');
            window.open(url, '_blank');
          }
        }).catch(()=>{
          const url = './' + p.replace(/^\/+/, '');
          window.open(url, '_blank');
        });
      }catch(e){ console.warn('viewFileHTTP failed', e); alert('HTTP 表示に失敗しました。簡易サーバが起動しているか確認してください。'); }
    }

    // start by loading FAQ data
    loadFAQFromJSON();

  </script>
</body>
</html>