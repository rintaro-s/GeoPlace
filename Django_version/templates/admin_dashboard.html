{% extends 'base.html' %}

{% block extra_css %}
<style>
    .dashboard-card {
        background: #2d2d2d;
        border: 1px solid #444;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        text-align: center;
        padding: 20px;
        background: linear-gradient(135deg, #4CAF50, #45a049);
        border-radius: 8px;
        color: white;
        margin-bottom: 15px;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .job-item {
        background: #3d3d3d;
        border: 1px solid #555;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 10px;
    }
    
    .job-progress {
        height: 8px;
        background: #555;
        border-radius: 4px;
        overflow: hidden;
        margin: 10px 0;
    }
    
    .job-progress-bar {
        height: 100%;
        background: #4CAF50;
        transition: width 0.3s ease;
    }
    
    .status-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-queued { background: #FF9800; }
    .status-processing { background: #2196F3; }
    .status-completed { background: #4CAF50; }
    .status-failed { background: #f44336; }
    
    .model-status {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        background: #3d3d3d;
        border-radius: 4px;
        margin-bottom: 8px;
    }
    
    .log-viewer {
        background: #1a1a1a;
        border: 1px solid #444;
        border-radius: 4px;
        padding: 15px;
        font-family: monospace;
        font-size: 12px;
        height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
    }
    
    .action-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 15px;
    }
    
    .refresh-indicator {
        display: inline-block;
        margin-left: 10px;
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .refresh-indicator.active {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- System Overview -->
    <div class="col-md-12 mb-4">
        <h2><i class="fas fa-tachometer-alt"></i> システム管理ダッシュボード</h2>
    </div>
</div>

<div class="row">
    <!-- Statistics Cards -->
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-number" id="total-tiles">0</div>
            <div class="stat-label">総タイル数</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" style="background: linear-gradient(135deg, #2196F3, #1976D2);">
            <div class="stat-number" id="total-objects">0</div>
            <div class="stat-label">3Dオブジェクト</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" style="background: linear-gradient(135deg, #FF9800, #F57C00);">
            <div class="stat-number" id="active-jobs">0</div>
            <div class="stat-label">実行中ジョブ</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" style="background: linear-gradient(135deg, #9C27B0, #7B1FA2);">
            <div class="stat-number" id="total-jobs">0</div>
            <div class="stat-label">総ジョブ数</div>
        </div>
    </div>
</div>

<div class="row">
    <!-- AI Models Status -->
    <div class="col-md-6">
        <div class="dashboard-card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-robot"></i> AIモデル状態
                    <span class="refresh-indicator" id="models-refresh">
                        <i class="fas fa-sync fa-spin"></i>
                    </span>
                </h5>
            </div>
            <div class="card-body">
                <div id="model-status-list">
                    <div class="model-status">
                        <span><i class="fas fa-eye"></i> LM Studio (VLM)</span>
                        <span class="status-indicator status-loading">確認中...</span>
                    </div>
                    <div class="model-status">
                        <span><i class="fas fa-image"></i> Stable Diffusion</span>
                        <span class="status-indicator status-loading">確認中...</span>
                    </div>
                    <div class="model-status">
                        <span><i class="fas fa-cube"></i> TripoSR</span>
                        <span class="status-indicator status-loading">確認中...</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-outline-primary btn-sm" id="test-vlm">
                        <i class="fas fa-vial"></i> VLMテスト
                    </button>
                    <button class="btn btn-outline-primary btn-sm" id="test-sd">
                        <i class="fas fa-vial"></i> SDテスト
                    </button>
                    <button class="btn btn-outline-primary btn-sm" id="test-triposr">
                        <i class="fas fa-vial"></i> TripoSRテスト
                    </button>
                    <button class="btn btn-outline-success btn-sm" id="restart-workers">
                        <i class="fas fa-redo"></i> ワーカー再起動
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Active Jobs -->
    <div class="col-md-6">
        <div class="dashboard-card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-tasks"></i> アクティブジョブ
                    <span class="refresh-indicator" id="jobs-refresh">
                        <i class="fas fa-sync fa-spin"></i>
                    </span>
                </h5>
            </div>
            <div class="card-body">
                <div id="active-jobs-list">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <div>アクティブなジョブはありません</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- System Actions -->
    <div class="col-md-4">
        <div class="dashboard-card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> システム操作</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-success" id="start-generation">
                        <i class="fas fa-play"></i> 3D生成開始
                    </button>
                    <button class="btn btn-warning" id="clear-cache">
                        <i class="fas fa-broom"></i> キャッシュクリア
                    </button>
                    <button class="btn btn-info" id="export-data">
                        <i class="fas fa-download"></i> データエクスポート
                    </button>
                    <button class="btn btn-danger" id="emergency-stop">
                        <i class="fas fa-stop"></i> 緊急停止
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="col-md-8">
        <div class="dashboard-card">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> 最近のアクティビティ</h5>
            </div>
            <div class="card-body">
                <div id="recent-activity">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-history fa-2x mb-2"></i>
                        <div>アクティビティを読み込み中...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- System Logs -->
    <div class="col-md-12">
        <div class="dashboard-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-file-alt"></i> システムログ</h5>
                <div>
                    <button class="btn btn-outline-light btn-sm" id="clear-logs">
                        <i class="fas fa-trash"></i> クリア
                    </button>
                    <button class="btn btn-outline-light btn-sm" id="refresh-logs">
                        <i class="fas fa-sync"></i> 更新
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="log-viewer" id="system-logs">
                    システムログを読み込み中...
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class AdminDashboard {
    constructor() {
        this.refreshInterval = 5000; // 5 seconds
        this.logLines = [];
        this.maxLogLines = 1000;
        
        this.bindEvents();
        this.startAutoRefresh();
        this.loadInitialData();
    }
    
    bindEvents() {
        // Model testing
        document.getElementById('test-vlm').addEventListener('click', () => this.testModel('vlm'));
        document.getElementById('test-sd').addEventListener('click', () => this.testModel('sd'));
        document.getElementById('test-triposr').addEventListener('click', () => this.testModel('triposr'));
        
        // System actions
        document.getElementById('start-generation').addEventListener('click', () => this.startGeneration());
        document.getElementById('clear-cache').addEventListener('click', () => this.clearCache());
        document.getElementById('export-data').addEventListener('click', () => this.exportData());
        document.getElementById('emergency-stop').addEventListener('click', () => this.emergencyStop());
        document.getElementById('restart-workers').addEventListener('click', () => this.restartWorkers());
        
        // Log actions
        document.getElementById('clear-logs').addEventListener('click', () => this.clearLogs());
        document.getElementById('refresh-logs').addEventListener('click', () => this.refreshLogs());
    }
    
    async loadInitialData() {
        await Promise.all([
            this.updateStatistics(),
            this.updateModelStatus(),
            this.updateActiveJobs(),
            this.updateRecentActivity()
        ]);
    }
    
    startAutoRefresh() {
        setInterval(() => {
            this.updateStatistics();
            this.updateActiveJobs();
            this.updateRecentActivity();
        }, this.refreshInterval);
        
        // Update model status less frequently
        setInterval(() => {
            this.updateModelStatus();
        }, this.refreshInterval * 6); // Every 30 seconds
    }
    
    async updateStatistics() {
        try {
            const stats = await apiRequest('canvas/stats/');
            
            document.getElementById('total-tiles').textContent = stats.tiles.in_database;
            document.getElementById('total-objects').textContent = stats.objects.total;
            document.getElementById('active-jobs').textContent = stats.jobs.active;
            
            const systemStatus = await apiRequest('system/status/');
            document.getElementById('total-jobs').textContent = systemStatus.jobs.total;
            
        } catch (error) {
            console.error('Failed to update statistics:', error);
        }
    }
    
    async updateModelStatus() {
        const indicator = document.getElementById('models-refresh');
        indicator.classList.add('active');
        
        try {
            const status = await apiRequest('system/models/');
            const statusList = document.getElementById('model-status-list');
            
            const models = [
                { key: 'lm_studio', name: 'LM Studio (VLM)', icon: 'fas fa-eye' },
                { key: 'stable_diffusion', name: 'Stable Diffusion', icon: 'fas fa-image' },
                { key: 'triposr', name: 'TripoSR', icon: 'fas fa-cube' }
            ];
            
            statusList.innerHTML = '';
            
            models.forEach(model => {
                const modelStatus = status[model.key] || 'unknown';
                const statusClass = `status-${modelStatus}`;
                const statusText = {
                    'ready': '準備完了',
                    'loading': '読み込み中',
                    'error': 'エラー',
                    'unknown': '不明'
                }[modelStatus] || '不明';
                
                const div = document.createElement('div');
                div.className = 'model-status';
                div.innerHTML = `
                    <span><i class="${model.icon}"></i> ${model.name}</span>
                    <span class="status-indicator ${statusClass}">${statusText}</span>
                `;
                statusList.appendChild(div);
            });
            
        } catch (error) {
            console.error('Failed to update model status:', error);
        } finally {
            indicator.classList.remove('active');
        }
    }
    
    async updateActiveJobs() {
        const indicator = document.getElementById('jobs-refresh');
        indicator.classList.add('active');
        
        try {
            const response = await apiRequest('jobs/active/');
            const jobsList = document.getElementById('active-jobs-list');
            
            if (response.length === 0) {
                jobsList.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <div>アクティブなジョブはありません</div>
                    </div>
                `;
                return;
            }
            
            jobsList.innerHTML = '';
            
            response.forEach(job => {
                const percentage = job.progress_percentage || 0;
                const statusClass = `status-${job.status}`;
                
                const div = document.createElement('div');
                div.className = 'job-item';
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <strong>${job.job_id}</strong>
                            <div class="small text-muted">${job.current_tile || ''}</div>
                        </div>
                        <div class="text-end">
                            <span class="status-dot ${statusClass}"></span>
                            <span class="small">${job.status}</span>
                        </div>
                    </div>
                    <div class="job-progress">
                        <div class="job-progress-bar" style="width: ${percentage}%"></div>
                    </div>
                    <div class="small text-muted">
                        ${job.progress}/${job.total_tiles} タイル (${percentage.toFixed(1)}%)
                    </div>
                `;
                
                jobsList.appendChild(div);
            });
            
        } catch (error) {
            console.error('Failed to update active jobs:', error);
        } finally {
            indicator.classList.remove('active');
        }
    }
    
    async updateRecentActivity() {
        try {
            // Get recent jobs and tiles
            const [recentJobs, recentTiles] = await Promise.all([
                apiRequest('jobs/?since_hours=24'),
                apiRequest('tiles/modified/?since_minutes=60')
            ]);
            
            const activityDiv = document.getElementById('recent-activity');
            const activities = [];
            
            // Add recent jobs
            recentJobs.results?.slice(0, 5).forEach(job => {
                activities.push({
                    time: new Date(job.created_at),
                    type: 'job',
                    text: `ジョブ ${job.job_id} が${job.status}`,
                    icon: 'fas fa-cogs',
                    status: job.status
                });
            });
            
            // Add recent tile modifications
            recentTiles.tiles?.slice(0, 5).forEach(tile => {
                activities.push({
                    time: new Date(tile.updated_at),
                    type: 'tile',
                    text: `タイル (${tile.x}, ${tile.y}) が更新されました`,
                    icon: 'fas fa-paint-brush',
                    status: 'updated'
                });
            });
            
            // Sort by time
            activities.sort((a, b) => b.time - a.time);
            
            if (activities.length === 0) {
                activityDiv.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-history fa-2x mb-2"></i>
                        <div>最近のアクティビティはありません</div>
                    </div>
                `;
                return;
            }
            
            activityDiv.innerHTML = '';
            
            activities.slice(0, 10).forEach(activity => {
                const div = document.createElement('div');
                div.className = 'activity-item d-flex align-items-center mb-2 p-2';
                div.style.cssText = 'background: #3d3d3d; border-radius: 4px;';
                
                div.innerHTML = `
                    <i class="${activity.icon} me-3" style="color: #4CAF50;"></i>
                    <div class="flex-grow-1">
                        <div>${activity.text}</div>
                        <small class="text-muted">${formatTimestamp(activity.time)}</small>
                    </div>
                `;
                
                activityDiv.appendChild(div);
            });
            
        } catch (error) {
            console.error('Failed to update recent activity:', error);
        }
    }
    
    async testModel(modelType) {
        const button = document.getElementById(`test-${modelType}`);
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> テスト中...';
        button.disabled = true;
        
        try {
            // Implement model testing logic here
            await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate test
            
            showNotification(`${modelType.toUpperCase()} テストが完了しました`, 'success');
            
        } catch (error) {
            console.error(`${modelType} test failed:`, error);
            showNotification(`${modelType.toUpperCase()} テストに失敗しました`, 'error');
        } finally {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }
    
    async startGeneration() {
        try {
            const response = await apiRequest('generate/start/', {
                method: 'POST',
                body: JSON.stringify({})
            });
            
            if (response.success) {
                showNotification(`3D生成を開始しました (ジョブID: ${response.job_id})`, 'success');
                this.updateActiveJobs();
            } else {
                showNotification('3D生成の開始に失敗しました', 'error');
            }
            
        } catch (error) {
            console.error('Failed to start generation:', error);
            showNotification('3D生成の開始に失敗しました: ' + error.message, 'error');
        }
    }
    
    async clearCache() {
        if (!confirm('キャッシュをクリアしますか？')) return;
        
        try {
            // Implement cache clearing logic
            showNotification('キャッシュをクリアしました', 'success');
        } catch (error) {
            console.error('Failed to clear cache:', error);
            showNotification('キャッシュのクリアに失敗しました', 'error');
        }
    }
    
    async exportData() {
        try {
            const data = await apiRequest('objects/list/');
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `geoplace_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showNotification('データをエクスポートしました', 'success');
            
        } catch (error) {
            console.error('Failed to export data:', error);
            showNotification('データのエクスポートに失敗しました', 'error');
        }
    }
    
    async emergencyStop() {
        if (!confirm('すべてのジョブを緊急停止しますか？')) return;
        
        try {
            // Implement emergency stop logic
            showNotification('緊急停止を実行しました', 'warning');
            this.updateActiveJobs();
        } catch (error) {
            console.error('Failed to emergency stop:', error);
            showNotification('緊急停止に失敗しました', 'error');
        }
    }
    
    async restartWorkers() {
        if (!confirm('ワーカーを再起動しますか？')) return;
        
        try {
            // Implement worker restart logic
            showNotification('ワーカーを再起動しました', 'success');
        } catch (error) {
            console.error('Failed to restart workers:', error);
            showNotification('ワーカーの再起動に失敗しました', 'error');
        }
    }
    
    clearLogs() {
        this.logLines = [];
        document.getElementById('system-logs').textContent = 'ログがクリアされました。';
    }
    
    refreshLogs() {
        // Simulate log refresh
        const logs = document.getElementById('system-logs');
        logs.textContent = 'ログを更新中...';
        
        setTimeout(() => {
            const sampleLogs = [
                `[${new Date().toISOString()}] INFO: システム正常稼働中`,
                `[${new Date().toISOString()}] INFO: VLM分析完了 - tile_150_200`,
                `[${new Date().toISOString()}] INFO: SD生成完了 - job_12345`,
                `[${new Date().toISOString()}] INFO: TripoSR処理開始`,
                `[${new Date().toISOString()}] INFO: 3Dオブジェクト登録完了`
            ];
            
            logs.textContent = sampleLogs.join('\n');
        }, 1000);
    }
    
    addLogLine(line) {
        this.logLines.push(`[${new Date().toISOString()}] ${line}`);
        
        if (this.logLines.length > this.maxLogLines) {
            this.logLines = this.logLines.slice(-this.maxLogLines);
        }
        
        const logs = document.getElementById('system-logs');
        logs.textContent = this.logLines.join('\n');
        logs.scrollTop = logs.scrollHeight;
    }
}

// WebSocket message handler for admin updates
function handleWebSocketMessage(data) {
    if (data.type === 'job_status_update') {
        // Update job status in real-time
        if (window.adminDashboard) {
            window.adminDashboard.updateActiveJobs();
        }
    } else if (data.type === 'system_log') {
        // Add new log line
        if (window.adminDashboard) {
            window.adminDashboard.addLogLine(data.message);
        }
    }
}

// Initialize admin dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
    window.adminDashboard = new AdminDashboard();
});
</script>
{% endblock %}
