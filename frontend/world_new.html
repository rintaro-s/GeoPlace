<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoPlace - 3D World</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        #ui {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            color: white;
            min-width: 250px;
        }
        
        #controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            color: white;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
            font-size: 12px;
        }
        
        button:hover { background: #45a049; }
        
        .status { color: #4CAF50; font-weight: bold; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
        
        #object-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .object-item {
            padding: 5px;
            border-bottom: 1px solid #444;
            cursor: pointer;
        }
        
        .object-item:hover {
            background: rgba(76, 175, 80, 0.2);
        }
    </style>
</head>
<body>
    <div id="ui">
        <h3>üåç 3D World</h3>
        <div id="status">Loading...</div>
        <div>Objects: <span id="object-count">0</span></div>
        <div>Position: <span id="position">0, 0, 0</span></div>
        <div id="object-list"></div>
    </div>
    
    <div id="controls">
        <h4>Controls</h4>
        <button onclick="refreshObjects()">üîÑ Refresh</button>
        <button onclick="resetCamera()">üì∑ Reset View</button>
        <button onclick="window.open('/paint', '_blank')">üé® Paint Tool</button>
        <button onclick="window.open('/admin', '_blank')">‚öôÔ∏è Admin</button>
    </div>

    <a-scene 
        background="color: #87CEEB"
        fog="type: linear; color: #87CEEB; near: 50; far: 200"
        vr-mode-ui="enabled: false">
        
        <!-- Lighting -->
        <a-light type="ambient" color="#404040"></a-light>
        <a-light type="directional" position="10 20 10" color="#ffffff" intensity="0.8"></a-light>
        
        <!-- Ground -->
        <a-plane 
            position="0 -0.5 0" 
            rotation="-90 0 0" 
            width="1000" 
            height="1000" 
            color="#228B22" 
            shadow="receive: true">
        </a-plane>
        
        <!-- Grid -->
        <a-entity id="grid-system">
            <!-- Grid lines will be added dynamically -->
        </a-entity>
        
        <!-- Camera with movement controls -->
        <a-entity id="camera-rig" position="0 5 10">
            <a-camera 
                id="camera"
                look-controls="pointerLockEnabled: true"
                wasd-controls="fly: true; acceleration: 20"
                position="0 0 0">
            </a-camera>
        </a-entity>
        
        <!-- Objects container -->
        <a-entity id="objects-container"></a-entity>
    </a-scene>

    <script>
        let objects = [];
        let camera, cameraRig, objectsContainer;
        
        document.addEventListener('DOMContentLoaded', init);
        
        function init() {
            // Get A-Frame elements
            camera = document.querySelector('#camera');
            cameraRig = document.querySelector('#camera-rig');
            objectsContainer = document.querySelector('#objects-container');
            
            // Setup grid
            createGrid();
            
            // Load initial objects
            loadObjects();
            
            // Setup position tracking
            setInterval(updatePosition, 1000);
            
            log('3D World initialized', 'status');
        }
        
        function createGrid() {
            const gridContainer = document.querySelector('#grid-system');
            const gridSize = 100;
            const gridSpacing = 10;
            
            // Create grid lines
            for (let i = -gridSize; i <= gridSize; i += gridSpacing) {
                // X-axis lines
                const lineX = document.createElement('a-box');
                lineX.setAttribute('position', `${i} 0 0`);
                lineX.setAttribute('width', '0.1');
                lineX.setAttribute('height', '0.1');
                lineX.setAttribute('depth', gridSize * 2);
                lineX.setAttribute('color', '#444444');
                gridContainer.appendChild(lineX);
                
                // Z-axis lines
                const lineZ = document.createElement('a-box');
                lineZ.setAttribute('position', `0 0 ${i}`);
                lineZ.setAttribute('width', gridSize * 2);
                lineZ.setAttribute('height', '0.1');
                lineZ.setAttribute('depth', '0.1');
                lineZ.setAttribute('color', '#444444');
                gridContainer.appendChild(lineZ);
            }
        }
        
        async function loadObjects() {
            try {
                log('Loading 3D objects...', 'info');
                
                const response = await fetch('/objects.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                objects = await response.json();
                renderObjects();
                
                log(`‚úÖ Loaded ${objects.length} objects`, 'status');
                
            } catch (error) {
                log(`‚ùå Failed to load objects: ${error.message}`, 'error');
            }
        }
        
        function renderObjects() {
            // Clear existing objects
            objectsContainer.innerHTML = '';
            
            // Update UI
            document.getElementById('object-count').textContent = objects.length;
            
            // Render object list
            const objectList = document.getElementById('object-list');
            objectList.innerHTML = '';
            
            objects.forEach((obj, index) => {
                // Create 3D object
                const entity = document.createElement('a-entity');
                entity.setAttribute('id', `object-${obj.id || index}`);
                entity.setAttribute('position', `${obj.x || 0} ${(obj.y || 0) + 1} ${obj.z || 0}`);
                
                if (obj.glb_url && obj.glb_url !== '/assets/glb/GLB_PLACEHOLDER') {
                    if (obj.glb_url.endsWith('.obj')) {
                        // Handle OBJ files
                        entity.setAttribute('obj-model', `obj: ${obj.glb_url}`);
                    } else {
                        // Handle GLB files
                        entity.setAttribute('gltf-model', obj.glb_url);
                    }
                    entity.setAttribute('scale', '0.5 0.5 0.5');
                } else {
                    // Fallback: colored box
                    entity.setAttribute('geometry', 'primitive: box; width: 1; height: 1; depth: 1');
                    const colors = ['#ff4444', '#44ff44', '#4444ff', '#ffff44', '#ff44ff'];
                    entity.setAttribute('material', `color: ${colors[index % colors.length]}`);
                }
                
                // Add shadow
                entity.setAttribute('shadow', 'cast: true; receive: true');
                
                // Add click interaction
                entity.setAttribute('cursor-listener', '');
                entity.addEventListener('click', () => {
                    focusOnObject(obj);
                });
                
                objectsContainer.appendChild(entity);
                
                // Add to UI list
                const listItem = document.createElement('div');
                listItem.className = 'object-item';
                listItem.textContent = `${obj.id || index}: (${obj.x}, ${obj.y}, ${obj.z})`;
                listItem.onclick = () => focusOnObject(obj);
                objectList.appendChild(listItem);
            });
        }
        
        function focusOnObject(obj) {
            const targetPos = `${obj.x} ${(obj.y || 0) + 5} ${(obj.z || 0) + 5}`;
            cameraRig.setAttribute('animation', `property: position; to: ${targetPos}; dur: 1000`);
            log(`Focusing on object at (${obj.x}, ${obj.y}, ${obj.z})`, 'info');
        }
        
        function updatePosition() {
            if (cameraRig) {
                const pos = cameraRig.getAttribute('position');
                const posText = `${Math.round(pos.x)}, ${Math.round(pos.y)}, ${Math.round(pos.z)}`;
                document.getElementById('position').textContent = posText;
            }
        }
        
        function refreshObjects() {
            log('Refreshing objects...', 'info');
            loadObjects();
        }
        
        function resetCamera() {
            cameraRig.setAttribute('position', '0 5 10');
            camera.setAttribute('rotation', '0 0 0');
            log('Camera reset', 'info');
        }
        
        function log(message, type = 'info') {
            const status = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            
            status.innerHTML = `<span class="${type}">[${timestamp}] ${message}</span>`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // Register cursor listener component
        AFRAME.registerComponent('cursor-listener', {
            init: function () {
                this.el.addEventListener('mouseenter', function () {
                    this.setAttribute('scale', '1.1 1.1 1.1');
                });
                this.el.addEventListener('mouseleave', function () {
                    this.setAttribute('scale', '1 1 1');
                });
            }
        });
    </script>
</body>
</html>
