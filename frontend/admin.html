<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>dot2world - ç®¡ç†ç”»é¢</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; padding: 20px; 
      background: #1a1a1a; color: #fff;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #4CAF50;
      text-align: center;
      margin-bottom: 30px;
    }
    .section {
      background: #2d2d2d;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      border: 1px solid #444;
    }
    .section h3 {
      color: #4CAF50;
      margin-top: 0;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    .status-box {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 4px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #555;
    }
    .success { color: #4CAF50; }
    .error { color: #ff6b6b; }
    .warning { color: #ffa726; }
    .info { color: #2196F3; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    .stat-card {
      background: #3a3a3a;
      padding: 15px;
      border-radius: 6px;
      text-align: center;
    }
    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
    }
    .stat-label {
      font-size: 12px;
      color: #ccc;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ› ï¸ dot2world ç®¡ç†ç”»é¢</h1>
    
    <div class="grid">
      <div class="stat-card">
        <div class="stat-number" id="object-count">-</div>
        <div class="stat-label">3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="tile-count">-</div>
        <div class="stat-label">å¤‰æ›´ã‚¿ã‚¤ãƒ«æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="job-count">-</div>
        <div class="stat-label">å®Ÿè¡Œä¸­ã‚¸ãƒ§ãƒ–æ•°</div>
      </div>
    </div>
    
    <div class="section">
      <h3>ğŸ¤– AIãƒ¢ãƒ‡ãƒ«çŠ¶æ…‹</h3>
      <button id="btn-model-status">ãƒ¢ãƒ‡ãƒ«çŠ¶æ…‹ã‚’ç¢ºèª</button>
      <button id="btn-reload-models">ãƒ¢ãƒ‡ãƒ«å†èª­ã¿è¾¼ã¿</button>
      <div class="status-box" id="model-status">ãƒ¢ãƒ‡ãƒ«çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
    </div>
    
    <div class="section">
      <h3>ğŸ—‚ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†</h3>
      <button id="btn-clear-cache">ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢</button>
      <button id="btn-clear-tiles">ã‚¿ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢</button>
      <div class="status-box" id="cache-status">ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ“ä½œã®çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>
    
    <div class="section">
      <h3>âš™ï¸ ç”Ÿæˆç®¡ç†</h3>
      <button id="btn-generate-all">å…¨å¤‰æ›´ã‚¿ã‚¤ãƒ«3Dç”Ÿæˆ</button>
      <button id="btn-stop-jobs">å…¨ã‚¸ãƒ§ãƒ–åœæ­¢</button>
      <div class="status-box" id="generation-status">ç”Ÿæˆæ“ä½œã®çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>
    
    <div class="section">
      <h3>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h3>
      <button id="btn-system-info">ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±å–å¾—</button>
      <div class="status-box" id="system-info">ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>
    
    <div class="section">
      <h3>ğŸ—ƒï¸ ãƒ¢ãƒ‡ãƒ«ç®¡ç†</h3>
      <button id="btn-list-models">ãƒ¢ãƒ‡ãƒ«ä¸€è¦§è¡¨ç¤º</button>
      <button id="btn-delete-all-models" style="background: #f44336;">å…¨ãƒ¢ãƒ‡ãƒ«å‰Šé™¤</button>
      <div class="status-box" id="model-list">ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>
    
    <div class="section">
      <h3>ğŸ–¼ï¸ ç”»åƒç®¡ç†</h3>
      <button id="btn-list-images">ç”»åƒä¸€è¦§è¡¨ç¤º</button>
      <button id="btn-delete-all-images" style="background: #f44336;">å…¨ç”»åƒå‰Šé™¤</button>
      <div class="status-box" id="image-list">ç”»åƒä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>
    
    <div class="section">
      <h3>ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
      <button id="btn-preview-latest">æœ€æ–°ãƒ¢ãƒ‡ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
      <div class="status-box" id="preview-area">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>

    <div class="section">
      <h3>ğŸ”— ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ³ã‚¯</h3>
      <button onclick="window.open('/frontend/paint.html', '_blank')">ğŸ¨ ãƒšã‚¤ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«</button>
      <button onclick="window.open('/frontend/world.html', '_blank')">ğŸŒ 3Dãƒ¯ãƒ¼ãƒ«ãƒ‰</button>
      <button onclick="window.open('/api/objects.json', '_blank')">ğŸ“„ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆJSON</button>
    </div>
  </div>

  <script>
    let baseUrl = '';
    if (location.protocol === 'file:') {
      baseUrl = 'http://127.0.0.1:8001';
    }
    
    // Utility functions
    function formatJson(obj) {
      return JSON.stringify(obj, null, 2);
    }
    
    function showStatus(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      const timestamp = new Date().toLocaleTimeString('ja-JP');
      const className = type;
      el.innerHTML = `<div class="${className}">[${timestamp}] ${message}</div>` + el.innerHTML;
    }
    
    function showError(elementId, error) {
      showStatus(elementId, `ã‚¨ãƒ©ãƒ¼: ${error.message || error}`, 'error');
    }
    
    // Model status
    document.getElementById('btn-model-status').onclick = async () => {
      try {
        showStatus('model-status', 'ãƒ¢ãƒ‡ãƒ«çŠ¶æ…‹ã‚’ç¢ºèªä¸­...', 'info');
        const res = await fetch(baseUrl + '/api/admin/models');
        const j = await res.json();
        
        let statusHtml = '<div class="success">ãƒ¢ãƒ‡ãƒ«çŠ¶æ…‹:</div>';
        statusHtml += `<div>Stable Diffusion: ${j.sd_loaded ? '<span class="success">âœ… èª­ã¿è¾¼ã¿æ¸ˆã¿</span>' : '<span class="error">âŒ æœªèª­ã¿è¾¼ã¿</span>'}</div>`;
        if (j.sd_error) {
          statusHtml += `<div class="error">ã‚¨ãƒ©ãƒ¼: ${j.sd_error}</div>`;
        }
        statusHtml += `<pre>${formatJson(j)}</pre>`;
        
        document.getElementById('model-status').innerHTML = statusHtml;
      } catch (error) {
        showError('model-status', error);
      }
    };
    
    // Cache management
    document.getElementById('btn-clear-cache').onclick = async () => {
      try {
        showStatus('cache-status', 'ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ä¸­...', 'info');
        const res = await fetch(baseUrl + '/api/admin/clear_cache', {method:'POST'});
        const j = await res.json();
        showStatus('cache-status', `ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å®Œäº†: ${formatJson(j)}`, 'success');
      } catch (error) {
        showError('cache-status', error);
      }
    };
    
    // Generation management
    document.getElementById('btn-generate-all').onclick = async () => {
      try {
        showStatus('generation-status', 'å…¨å¤‰æ›´ã‚¿ã‚¤ãƒ«ã®3Dç”Ÿæˆã‚’é–‹å§‹ä¸­...', 'info');
        const res = await fetch(baseUrl + '/api/generate', {
          method:'POST', 
          headers:{'content-type':'application/json'}, 
          body: JSON.stringify({tiles: null})
        });
        const j = await res.json();
        showStatus('generation-status', `ç”Ÿæˆã‚¸ãƒ§ãƒ–é–‹å§‹: ${formatJson(j)}`, 'success');
      } catch (error) {
        showError('generation-status', error);
      }
    };
    
    // System info
    document.getElementById('btn-system-info').onclick = async () => {
      try {
        showStatus('system-info', 'ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’å–å¾—ä¸­...', 'info');
        
        // Get multiple endpoints
        const [objectsRes, tilesRes] = await Promise.all([
          fetch(baseUrl + '/api/objects.json').catch(() => ({json: () => []})),
          fetch(baseUrl + '/api/tiles').catch(() => ({json: () => []}))
        ]);
        
        const objects = await objectsRes.json();
        const tiles = await tilesRes.json();
        
        const info = {
          timestamp: new Date().toISOString(),
          objects_count: objects.length,
          tiles_count: tiles.length,
          user_agent: navigator.userAgent,
          screen_resolution: `${screen.width}x${screen.height}`,
          viewport: `${window.innerWidth}x${window.innerHeight}`
        };
        
        document.getElementById('system-info').innerHTML = `
          <div class="success">ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±:</div>
          <pre>${formatJson(info)}</pre>
        `;
        
        // Update stats
        document.getElementById('object-count').textContent = objects.length;
        document.getElementById('tile-count').textContent = tiles.length;
        
      } catch (error) {
        showError('system-info', error);
      }
    };
    
    // Additional buttons
    document.getElementById('btn-reload-models').onclick = async () => {
      showStatus('model-status', 'ãƒ¢ãƒ‡ãƒ«å†èª­ã¿è¾¼ã¿æ©Ÿèƒ½ã¯æœªå®Ÿè£…ã§ã™', 'warning');
    };
    
    document.getElementById('btn-clear-tiles').onclick = async () => {
      showStatus('cache-status', 'ã‚¿ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢æ©Ÿèƒ½ã¯æœªå®Ÿè£…ã§ã™', 'warning');
    };
    
    document.getElementById('btn-stop-jobs').onclick = async () => {
      showStatus('generation-status', 'ã‚¸ãƒ§ãƒ–åœæ­¢æ©Ÿèƒ½ã¯æœªå®Ÿè£…ã§ã™', 'warning');
    };

    // Model management
    document.getElementById('btn-list-models').onclick = async () => {
      try {
        showStatus('model-list', 'ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’å–å¾—ä¸­...', 'info');
        const res = await fetch(baseUrl + '/assets/glb/');
        const text = await res.text();
        
        // Parse directory listing or use API if available
        let models = [];
        try {
          const apiRes = await fetch(baseUrl + '/api/models');
          models = await apiRes.json();
        } catch {
          // Fallback: parse HTML directory listing
          const parser = new DOMParser();
          const doc = parser.parseFromString(text, 'text/html');
          const links = doc.querySelectorAll('a[href$=".glb"], a[href$=".obj"]');
          models = Array.from(links).map(link => ({
            name: link.textContent,
            url: link.href,
            type: link.href.endsWith('.glb') ? 'GLB' : 'OBJ'
          }));
        }
        
        let html = '<div class="success">ãƒ¢ãƒ‡ãƒ«ä¸€è¦§:</div>';
        if (models.length === 0) {
          html += '<div>ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
        } else {
          models.forEach(model => {
            html += `<div>ğŸ“¦ ${model.name || model.url} (${model.type || 'Unknown'})</div>`;
          });
        }
        
        document.getElementById('model-list').innerHTML = html;
      } catch (error) {
        showError('model-list', error);
      }
    };

    document.getElementById('btn-delete-all-models').onclick = async () => {
      if (!confirm('æœ¬å½“ã«å…¨ã¦ã®ãƒ¢ãƒ‡ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
      
      try {
        showStatus('model-list', 'å…¨ãƒ¢ãƒ‡ãƒ«ã‚’å‰Šé™¤ä¸­...', 'warning');
        const res = await fetch(baseUrl + '/api/admin/delete_models', {method: 'POST'});
        const result = await res.json();
        showStatus('model-list', `å‰Šé™¤å®Œäº†: ${formatJson(result)}`, 'success');
      } catch (error) {
        showError('model-list', error);
      }
    };

    // Image management
    document.getElementById('btn-list-images').onclick = async () => {
      try {
        showStatus('image-list', 'ç”»åƒä¸€è¦§ã‚’å–å¾—ä¸­...', 'info');
        const res = await fetch(baseUrl + '/data/tiles/');
        const text = await res.text();
        
        // Parse directory listing
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, 'text/html');
        const links = doc.querySelectorAll('a[href$=".png"], a[href$=".jpg"], a[href$=".jpeg"]');
        const images = Array.from(links).map(link => link.textContent);
        
        let html = '<div class="success">ç”»åƒä¸€è¦§:</div>';
        if (images.length === 0) {
          html += '<div>ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
        } else {
          images.forEach(img => {
            html += `<div>ğŸ–¼ï¸ ${img}</div>`;
          });
        }
        
        document.getElementById('image-list').innerHTML = html;
      } catch (error) {
        showError('image-list', error);
      }
    };

    document.getElementById('btn-delete-all-images').onclick = async () => {
      if (!confirm('æœ¬å½“ã«å…¨ã¦ã®ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
      
      try {
        showStatus('image-list', 'å…¨ç”»åƒã‚’å‰Šé™¤ä¸­...', 'warning');
        const res = await fetch(baseUrl + '/api/admin/delete_images', {method: 'POST'});
        const result = await res.json();
        showStatus('image-list', `å‰Šé™¤å®Œäº†: ${formatJson(result)}`, 'success');
      } catch (error) {
        showError('image-list', error);
      }
    };

    // Preview functionality
    document.getElementById('btn-preview-latest').onclick = async () => {
      try {
        showStatus('preview-area', 'æœ€æ–°ãƒ¢ãƒ‡ãƒ«ã‚’æ¤œç´¢ä¸­...', 'info');
        const res = await fetch(baseUrl + '/api/objects.json');
        const objects = await res.json();
        
        if (objects.length === 0) {
          showStatus('preview-area', 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã‚‹ãƒ¢ãƒ‡ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
          return;
        }
        
        const latest = objects[objects.length - 1];
        const previewHtml = `
          <div class="success">æœ€æ–°ãƒ¢ãƒ‡ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</div>
          <div>ID: ${latest.id}</div>
          <div>ä½ç½®: (${latest.x}, ${latest.y}, ${latest.z})</div>
          <div>å“è³ª: ${latest.quality}</div>
          <div>URL: ${latest.glb_url}</div>
          <div style="margin-top: 10px;">
            <a href="${latest.glb_url}" target="_blank" style="color: #4CAF50;">ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã</a>
          </div>
        `;
        
        document.getElementById('preview-area').innerHTML = previewHtml;
      } catch (error) {
        showError('preview-area', error);
      }
    };
    
    // Auto-refresh stats every 30 seconds
    setInterval(() => {
      document.getElementById('btn-system-info').click();
    }, 30000);
    
    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btn-system-info').click();
      document.getElementById('btn-model-status').click();
    });
  </script>
</body>
</html>