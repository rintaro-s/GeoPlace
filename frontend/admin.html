<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GeoPlace Admin</title>
</head>
<body>
<<<<<<< HEAD
  <h1>Admin</h1>
  <div>
    <button id="btn-model-status">Get Model Status</button>
    <pre id="model-status">-</pre>
  </div>
  <div>
    <button id="btn-clear-cache">Clear Pipeline Cache</button>
    <span id="clear-res"></span>
  </div>
  <div>
    <button id="btn-generate-all">Trigger Generate (all modified)</button>
    <span id="gen-res"></span>
=======
  <div class="container">
    <h1>🛠️ dot2world 管理画面</h1>
    
    <div class="grid">
      <div class="stat-card">
        <div class="stat-number" id="object-count">-</div>
        <div class="stat-label">3Dオブジェクト数</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="tile-count">-</div>
        <div class="stat-label">変更タイル数</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="job-count">-</div>
        <div class="stat-label">実行中ジョブ数</div>
      </div>
    </div>
    
    <div class="section">
      <h3>🤖 AIモデル状態</h3>
      <button id="btn-model-status">モデル状態を確認</button>
      <button id="btn-reload-models">モデル再読み込み</button>
      <div class="status-box" id="model-status">モデル状態を確認してください</div>
    </div>
    
    <div class="section">
      <h3>🗂️ キャッシュ管理</h3>
      <button id="btn-clear-cache">パイプラインキャッシュクリア</button>
      <button id="btn-clear-tiles">タイルキャッシュクリア</button>
      <div class="status-box" id="cache-status">キャッシュ操作の結果がここに表示されます</div>
    </div>
    
    <div class="section">
      <h3>⚙️ 生成管理</h3>
      <button id="btn-generate-all">全変更タイル3D生成</button>
      <button id="btn-stop-jobs">全ジョブ停止</button>
      <div class="status-box" id="generation-status">生成操作の結果がここに表示されます</div>
    </div>
    
    <div class="section">
      <h3>📊 システム情報</h3>
      <button id="btn-system-info">システム情報取得</button>
      <div class="status-box" id="system-info">システム情報がここに表示されます</div>
    </div>
    
    <div class="section">
      <h3>🗃️ モデル管理</h3>
      <button id="btn-list-models">モデル一覧表示</button>
      <button id="btn-delete-all-models" style="background: #f44336;">全モデル削除</button>
      <div class="status-box" id="model-list">モデル一覧がここに表示されます</div>
    </div>
    
    <div class="section">
      <h3>🖼️ 画像管理</h3>
      <button id="btn-list-images">画像一覧表示</button>
      <button id="btn-delete-all-images" style="background: #f44336;">全画像削除</button>
      <div class="status-box" id="image-list">画像一覧がここに表示されます</div>
    </div>
    
    <div class="section">
      <h3>👁️ プレビュー</h3>
      <button id="btn-preview-latest">最新モデルプレビュー</button>
      <div class="status-box" id="preview-area">プレビューがここに表示されます</div>
    </div>

    <div class="section">
      <h3>🔗 クイックリンク</h3>
      <button onclick="window.open('/frontend/paint.html', '_blank')">🎨 ペイントツール</button>
      <button onclick="window.open('/frontend/world.html', '_blank')">🌍 3Dワールド</button>
      <button onclick="window.open('/api/objects.json', '_blank')">📄 オブジェクトJSON</button>
    </div>
>>>>>>> parent of 1056e71 (ゴミdjango)
  </div>

  <script>
    document.getElementById('btn-model-status').onclick = async () => {
      const res = await fetch('/api/admin/models');
      const j = await res.json();
      document.getElementById('model-status').textContent = JSON.stringify(j, null, 2);
    }
    document.getElementById('btn-clear-cache').onclick = async () => {
      const res = await fetch('/api/admin/clear_cache', {method:'POST'});
      const j = await res.json();
      document.getElementById('clear-res').textContent = JSON.stringify(j);
    }
    document.getElementById('btn-generate-all').onclick = async () => {
<<<<<<< HEAD
      const res = await fetch('/api/generate', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({tiles: null})});
      const j = await res.json();
      document.getElementById('gen-res').textContent = JSON.stringify(j);
    }
=======
      try {
        showStatus('generation-status', '全変更タイルの3D生成を開始中...', 'info');
        const res = await fetch(baseUrl + '/api/generate', {
          method:'POST', 
          headers:{'content-type':'application/json'}, 
          body: JSON.stringify({tiles: null})
        });
        const j = await res.json();
        showStatus('generation-status', `生成ジョブ開始: ${formatJson(j)}`, 'success');
      } catch (error) {
        showError('generation-status', error);
      }
    };
    
    // System info
    document.getElementById('btn-system-info').onclick = async () => {
      try {
        showStatus('system-info', 'システム情報を取得中...', 'info');
        
        // Get multiple endpoints
        const [objectsRes, tilesRes] = await Promise.all([
          fetch(baseUrl + '/api/objects.json').catch(() => ({json: () => []})),
          fetch(baseUrl + '/api/tiles').catch(() => ({json: () => []}))
        ]);
        
        const objects = await objectsRes.json();
        const tiles = await tilesRes.json();
        
        const info = {
          timestamp: new Date().toISOString(),
          objects_count: objects.length,
          tiles_count: tiles.length,
          user_agent: navigator.userAgent,
          screen_resolution: `${screen.width}x${screen.height}`,
          viewport: `${window.innerWidth}x${window.innerHeight}`
        };
        
        document.getElementById('system-info').innerHTML = `
          <div class="success">システム情報:</div>
          <pre>${formatJson(info)}</pre>
        `;
        
        // Update stats
        document.getElementById('object-count').textContent = objects.length;
        document.getElementById('tile-count').textContent = tiles.length;
        
      } catch (error) {
        showError('system-info', error);
      }
    };
    
    // Additional buttons
    document.getElementById('btn-reload-models').onclick = async () => {
      showStatus('model-status', 'モデル再読み込み機能は未実装です', 'warning');
    };
    
    document.getElementById('btn-clear-tiles').onclick = async () => {
      showStatus('cache-status', 'タイルキャッシュクリア機能は未実装です', 'warning');
    };
    
    document.getElementById('btn-stop-jobs').onclick = async () => {
      showStatus('generation-status', 'ジョブ停止機能は未実装です', 'warning');
    };

    // Model management
    document.getElementById('btn-list-models').onclick = async () => {
      try {
        showStatus('model-list', 'モデル一覧を取得中...', 'info');
        const res = await fetch(baseUrl + '/assets/glb/');
        const text = await res.text();
        
        // Parse directory listing or use API if available
        let models = [];
        try {
          const apiRes = await fetch(baseUrl + '/api/models');
          models = await apiRes.json();
        } catch {
          // Fallback: parse HTML directory listing
          const parser = new DOMParser();
          const doc = parser.parseFromString(text, 'text/html');
          const links = doc.querySelectorAll('a[href$=".glb"], a[href$=".obj"]');
          models = Array.from(links).map(link => ({
            name: link.textContent,
            url: link.href,
            type: link.href.endsWith('.glb') ? 'GLB' : 'OBJ'
          }));
        }
        
        let html = '<div class="success">モデル一覧:</div>';
        if (models.length === 0) {
          html += '<div>モデルが見つかりません</div>';
        } else {
          models.forEach(model => {
            html += `<div>📦 ${model.name || model.url} (${model.type || 'Unknown'})</div>`;
          });
        }
        
        document.getElementById('model-list').innerHTML = html;
      } catch (error) {
        showError('model-list', error);
      }
    };

    document.getElementById('btn-delete-all-models').onclick = async () => {
      if (!confirm('本当に全てのモデルを削除しますか？この操作は取り消せません。')) return;
      
      try {
        showStatus('model-list', '全モデルを削除中...', 'warning');
        const res = await fetch(baseUrl + '/api/admin/delete_models', {method: 'POST'});
        const result = await res.json();
        showStatus('model-list', `削除完了: ${formatJson(result)}`, 'success');
      } catch (error) {
        showError('model-list', error);
      }
    };

    // Image management
    document.getElementById('btn-list-images').onclick = async () => {
      try {
        showStatus('image-list', '画像一覧を取得中...', 'info');
        const res = await fetch(baseUrl + '/data/tiles/');
        const text = await res.text();
        
        // Parse directory listing
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, 'text/html');
        const links = doc.querySelectorAll('a[href$=".png"], a[href$=".jpg"], a[href$=".jpeg"]');
        const images = Array.from(links).map(link => link.textContent);
        
        let html = '<div class="success">画像一覧:</div>';
        if (images.length === 0) {
          html += '<div>画像が見つかりません</div>';
        } else {
          images.forEach(img => {
            html += `<div>🖼️ ${img}</div>`;
          });
        }
        
        document.getElementById('image-list').innerHTML = html;
      } catch (error) {
        showError('image-list', error);
      }
    };

    document.getElementById('btn-delete-all-images').onclick = async () => {
      if (!confirm('本当に全ての画像を削除しますか？この操作は取り消せません。')) return;
      
      try {
        showStatus('image-list', '全画像を削除中...', 'warning');
        const res = await fetch(baseUrl + '/api/admin/delete_images', {method: 'POST'});
        const result = await res.json();
        showStatus('image-list', `削除完了: ${formatJson(result)}`, 'success');
      } catch (error) {
        showError('image-list', error);
      }
    };

    // Preview functionality
    document.getElementById('btn-preview-latest').onclick = async () => {
      try {
        showStatus('preview-area', '最新モデルを検索中...', 'info');
        const res = await fetch(baseUrl + '/api/objects.json');
        const objects = await res.json();
        
        if (objects.length === 0) {
          showStatus('preview-area', 'プレビューできるモデルがありません', 'warning');
          return;
        }
        
        const latest = objects[objects.length - 1];
        const previewHtml = `
          <div class="success">最新モデルプレビュー:</div>
          <div>ID: ${latest.id}</div>
          <div>位置: (${latest.x}, ${latest.y}, ${latest.z})</div>
          <div>品質: ${latest.quality}</div>
          <div>URL: ${latest.glb_url}</div>
          <div style="margin-top: 10px;">
            <a href="${latest.glb_url}" target="_blank" style="color: #4CAF50;">モデルファイルを開く</a>
          </div>
        `;
        
        document.getElementById('preview-area').innerHTML = previewHtml;
      } catch (error) {
        showError('preview-area', error);
      }
    };
    
    // Auto-refresh stats every 30 seconds
    setInterval(() => {
      document.getElementById('btn-system-info').click();
    }, 30000);
    
    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btn-system-info').click();
      document.getElementById('btn-model-status').click();
    });
>>>>>>> parent of 1056e71 (ゴミdjango)
  </script>
</body>
</html>